<!DOCTYPE html>
<html>
<head>
    <title>Latency Time-Series Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h2>Latency Time-Series Visualization (ms)</h2>
    <canvas id="latencyChart"></canvas>
    <script>
        let chart; // Holds the Chart.js instance
        let timestamps = []; // X-axis time labels
        let latenciesPerHost = {}; // Stores data per host

        async function fetchLatencies() {
            try {
                // Fetch the latency data from your server
                const response = await fetch('http://localhost:8080');
                const data = await response.json();

                // Parse the latency data (convert ns to ms)
                const latencies = data.latencies.map(ns => ns / 1e6);

                // Add current timestamp to the X-axis labels
                const now = new Date();
                const formattedTime = now.toLocaleTimeString();
                timestamps.push(formattedTime);

                // Update latency data for each host
                latencies.forEach((latency, index) => {
                    const hostKey = `Host ${index + 1}`;
                    if (!latenciesPerHost[hostKey]) {
                        latenciesPerHost[hostKey] = []; // Initialize if it doesn't exist
                    }
                    latenciesPerHost[hostKey].push(latency);
                });

                // If the chart exists, update it; otherwise, create it
                if (chart) {
                    // Update the chart's data dynamically
                    chart.data.labels = timestamps; // Update time labels
                    chart.data.datasets.forEach(dataset => {
                        dataset.data = latenciesPerHost[dataset.label];
                    });
                    chart.update(); // Refresh the chart
                } else {
                    // Create the chart
                    const ctx = document.getElementById('latencyChart').getContext('2d');
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: timestamps, // Time labels (X-axis)
                            datasets: Object.keys(latenciesPerHost).map(hostKey => ({
                                label: hostKey, // Host label (e.g., "Host 1")
                                data: latenciesPerHost[hostKey], // Latency data for this host
                                borderColor: getRandomColor(), // Line color
                                backgroundColor: 'rgba(0, 0, 0, 0)', // Transparent background
                                tension: 0.2 // Smooth the line
                            }))
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Latency (ms)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Time'
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.raw.toFixed(2)} ms`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error fetching latency data:', error);
            }
        }

        // Generate a random color for each line
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Fetch latencies initially and then every 5 seconds
        fetchLatencies();
        setInterval(fetchLatencies, 1000);
    </script>
</body>
</html>
